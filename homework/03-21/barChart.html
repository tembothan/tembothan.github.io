<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Animated Bar Chart</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>

      body {
        margin: 0;
        background-color: #363636;
      }

    </style>
  </head>
  <body>

    <svg id="barchart">
      <g id="shapes"></g>
      <g id="x"></g>
      <g id="y"></g>
    </svg>

    <script>

      var url = "https://whiteboard.datawheel.us/api/google-analytics/realtime/random";
      var frequency = 5 * 1000; // 5 seconds
      var dataMax = 5; // size of array
      var data = []; // array of data
      var colorIndex = 0; // counter to select color from array
      var colorArray = ['#A5C8D6', '#FF6133', '#FAEFDF', '#B38EFF', '#C2F760', '#D6F7FA', '#5E6EE6'] // color array

      var width = window.innerWidth;
      var height = window.innerHeight;

      var margin = {top: 50, right: 50, bottom: 70, left: 100};

      var chartWidth = width - margin.left - margin.right;
      var chartHeight = height - margin.top - margin.bottom;

      var svg = d3.select("#barchart").attr("width", width).attr("height", height);

      var domainValues = d3.range(1, dataMax + 1);

      var x = d3.scaleBand().domain(domainValues.reverse()).range([margin.left, margin.left + chartWidth])
        .paddingInner(0.1)
        .paddingOuter(0.2);

      var barWidth = x.bandwidth();

      function fetchData() {

        d3.json(url)
          .then(function(users) {

            data.unshift({
              users: users,
              timestamp: new Date(),
              colorIndex: colorIndex
            });

            if (data.length > dataMax) {   
                data.pop();
                console.log(colorIndex);
                if (colorIndex > dataMax) {
                    colorIndex = 0; 
                }
            };

            colorIndex = colorIndex+1;

            var maxUsers = d3.max(data, function(d) {
              return d.users;
            });

            var barHeight = d3.scaleLinear().domain([0, maxUsers]).range([0, chartHeight]);

            var y = d3.scaleLinear().domain([0, maxUsers]).range([margin.top + chartHeight, margin.top]);

            var yAxis = d3.axisLeft(y);

            svg.select("#y").attr("stroke", "#ffffff").attr("fill", "#ffffff").attr("transform", "translate(" + margin.left + ", 0)")
              .transition().duration(frequency / 2)
              .call(yAxis);

            var xAxis = d3.axisBottom(x);

            svg.select("#x").attr("stroke", "#ffffff").attr("fill", "#ffffff").attr("transform", "translate(0, " + (chartHeight + margin.top) + ")")
              .transition().duration(frequency / 2)
              .call(xAxis);

            function zeroState(selection) {
              selection.attr("height", 0).attr("y", y(0));
            }

            function barPosition(selection) {
              selection.attr("height", function(d) {
                  return barHeight(d.users);
                })
                .attr("y", function(d) {
                  return y(d.users);
                });
            }

            // data binding
            var bars = svg.select("#shapes").selectAll(".bar")
              .data(data, function(d) {
                return d.timestamp;
              });

            // entering bars
            bars.enter().append("rect")
              .attr("class", "bar")
              .attr("width", barWidth)
              .attr("x", function(d, i) {
                return x(i + 1);
              })
              .attr("fill", colorArray[colorIndex])
              .call(zeroState)
              .transition().duration(frequency / 2)
              .call(barPosition);

            // updating bars
            bars.transition().duration(frequency / 2)
              .attr("x", function(d, i) {
                return x(i + 1);
              })
              .call(barPosition);

            // exiting bars
            bars.exit().transition().duration(frequency / 2).call(zeroState).remove();

          });

      }

      fetchData();
      setInterval(fetchData, frequency);


    </script>
  </body>
</html>
